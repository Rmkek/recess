// Generated by CoffeeScript 2.1.1
// REQUIRED MODULES #
var babelify, browserify, path, util;

path = require('path');

browserify = require('browserify');

babelify = require('babelify');

util = require('util');

module.exports = function(recess) {
  var plugin, reporter;
  reporter = recess.reporter;
  plugin = {};
  plugin.pipes = {
    bundle: function(bws = {
        presets: ["env", "vue-app"]
      }, bbs) {
      // PIPE #
      return recess.i.stream(async function(files, cond) {
        await recess.d.eachAsync(files, function(file) {
          return new Promise(function(resolve, reject) {
            var bundle, bws2;
            // new browserify bundle
            bws2 = Object.assign({
              basedir: path.resolve(cond.workdir, path.dirname(file.path))
            }, bws);
            // reporter.fatal util.format bws2
            bundle = browserify(file.contents, bws2); // set cwd to file name
            
            // add babelify
            bundle.transform(babelify, bbs);
            // start bundling
            return bundle.bundle(function(err, b) {
              if (err) {
                // throw error
                reporter.error(err);
              }
              file.contents = b;
              return resolve();
            });
          });
        });
        return files;
      });
    }
  };
  return plugin;
};
