// Generated by CoffeeScript 2.1.1
var fs, gaze;

gaze = require('gaze');

fs = require('fs-extra');

module.exports = function(punk) {
  var reporter, startPipe;
  reporter = punk.reporter;
  startPipe = async function(files, task) {
    var devnull, pipe, ref;
    ref = task.pipes;
    // pass files through pipes
    for (devnull in ref) {
      pipe = ref[devnull];
      await files.pipe(pipe);
    }
    // convert files
    if (task.to && !(task.outFile || task.outDir || task.outDirectory)) {
      await files.pipe(punk.p.to(task.to));
      task.outDir = './';
      await files.pipe(punk.p.write(task));
    } else if (task.to) {
      await files.pipe(punk.p.to(task.to));
    }
    if (task.min) {
      await files.pipe(punk.p.min());
    }
    if (task.start && task.start.length > 0) {
      await punk.run(task.start);
    }
    // write files to FS
    return (await files.pipe(punk.p.write(task)));
  };
  punk._runTask = async function(taskName, task) {
    var files;
    reporter.startingTask(taskName);
    // set settings to standard format
    task = punk.d.toSetting(task);
    files = new punk.Collection(void 0, task);
    await punk.run(task.needs);
    // load files
    await files.pipe(punk.p.add(task.entry));
    await startPipe(files, task);
    // report
    reporter.finishedTask(taskName);
  };
  return punk._watchTask = async function(taskName, task) {
    var changed, running;
    // r._runTask taskName, task
    // set settings to standard format
    task = punk.d.toSetting(task);
    await punk.watch(task.needs);
    running = false;
    // load files
    changed = async function(rg) {
      var files;
      files = new punk.Collection(void 0, task);
      if (rg) {
        await files.pipe(punk.p.add([rg]));
      } else {
        await files.pipe(punk.p.add(task.entry));
      }
      await startPipe(files, task);
      if (rg) {
        reporter.changed(rg);
      }
    };
    gaze(task.entry, function(err) {
      if (err) {
        throw err;
      }
      return this.on('all', async function(event, path) {
        await punk.d.sleep(punk.config.changedDelay);
        return (await changed(path));
      });
    });
  };
};
